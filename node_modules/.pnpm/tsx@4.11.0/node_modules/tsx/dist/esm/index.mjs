import{isMainThread as S}from"node:worker_threads";import{i as y,a as D,m as F}from"../node-features-Dcn4STxq.mjs";import{r as A}from"../register-B0bfVVOZ.mjs";import{l as w,c as u,e as I,i as E,f as M,g as _,h as P,d as b,r as $,a as v,t as T}from"../resolve-ts-path-DUkQ8uuR.mjs";import{fileURLToPath as k,pathToFileURL as L}from"node:url";import{b as q,t as C}from"../index-DiuW-CAd.mjs";import{p as O}from"../client-Cg7nS93t.mjs";import R from"node:path";import N from"node:fs";import"node:module";import"get-tsconfig";import"esbuild";import"node:crypto";import"node:os";import"../temporary-directory-CwHp0_NW.mjs";import"node:net";import"../get-pipe-path-CmcG6VNd.mjs";const m={active:!0},W=async t=>{if(!t)throw new Error(`tsx must be loaded with --import instead of --loader
The --loader flag was deprecated in Node v20.6.0 and v18.19.0`);m.namespace=t.namespace,t.tsconfig!==!1&&w(t.tsconfig??process.env.TSX_TSCONFIG_PATH),t.port&&(m.port=t.port,t.port.on("message",r=>{r==="deactivate"&&(m.active=!1,t.port.postMessage({type:"deactivated"}))}))},G=()=>(w(process.env.TSX_TSCONFIG_PATH),"process.setSourceMapsEnabled(true);"),p=new Map,Q=async t=>{if(p.has(t))return p.get(t);if(!await N.promises.access(t).then(()=>!0,()=>!1)){p.set(t,void 0);return}const s=await N.promises.readFile(t,"utf8");try{const e=JSON.parse(s);return p.set(t,e),e}catch{throw new Error(`Error parsing: ${t}`)}},H=async t=>{let r=new URL("package.json",t);for(;!r.pathname.endsWith("/node_modules/package.json");){const s=k(r),e=await Q(s);if(e)return e;const n=r;if(r=new URL("../package.json",r),r.pathname===n.pathname)break}},X=async t=>(await H(t))?.type??"commonjs",x=t=>{const r=t.indexOf("?"),s=R.extname(r===-1?t:t.slice(0,r));if(s===".json")return"json";if(s===".mjs"||s===".mts")return"module";if(s===".cjs"||s===".cts")return"commonjs"},K=t=>{const r=x(t);if(r)return r;if(u.test(t))return X(t)},f="tsx-namespace=",d=t=>{const r=t.indexOf(f);if(r===-1)return;const s=t[r-1];if(s!=="?"&&s!=="&")return;const e=r+f.length,n=t.indexOf("&",e);return n===-1?t.slice(e):t.slice(e,n)},g=y(D)?"importAttributes":"importAssertions",z=async(t,r,s)=>{if(!m.active||m.namespace&&m.namespace!==d(t))return s(t,r);if(m.port){const o=new URL(t);o.searchParams.delete("tsx-namespace"),m.port.postMessage({type:"load",url:o.toString()})}O.send&&O.send({type:"dependency",path:t}),I.test(t)&&(r[g]||(r[g]={}),r[g].type="json");const e=await s(t,r);if(!e.source)return e;const n=t.startsWith("file://")?k(t):t,a=e.source.toString();if(e.format==="json"||u.test(t)){const o=await q(a,n,{tsconfigRaw:M?.(n)});return{format:"module",source:E(o)}}if(e.format==="module"){const o=C(n,a);o&&(e.source=E(o))}return e},h=async(t,r,s)=>{const e=await t(r,s);return!e.format&&e.url.startsWith(v)&&(e.format=await K(e.url)),e},B=[".js",".json",".ts",".tsx",".jsx"],l=async(t,r,s)=>{const[e,n]=t.split("?");let a;for(const o of B)try{return await h(s,e+o+(n?`?${n}`:""),r)}catch(c){if(a===void 0&&c instanceof Error){const{message:i}=c;c.message=c.message.replace(`${o}'`,"'"),c.stack=c.stack.replace(i,c.message),a=c}}throw a},U=async(t,r,s)=>{const e=P.test(t),n=e?"index":"/index",[a,o]=t.split("?");try{return await l(a+n+(o?`?${o}`:""),r,s)}catch(c){if(!e)try{return await l(t,r,s)}catch{}const i=c,{message:J}=i;throw i.message=i.message.replace(`${n.replace("/",R.sep)}'`,"'"),i.stack=i.stack.replace(J,i.message),i}},j=async(t,r,s,e)=>{if(!m.active)return s(t,r);const n=r.parentURL&&d(r.parentURL);if(_(t)){let a=d(t);if(n&&!a&&(a=n,t+=`${t.includes("?")?"&":"?"}${f}${n}`),m.namespace&&m.namespace!==a)return s(t,r);if(P.test(t))return await U(t,r,s)}else if(T&&!r.parentURL?.includes("/node_modules/")){const a=T(t);for(const o of a)try{return await j(L(o).toString(),r,s)}catch{}}if(u.test(r.parentURL)||b){const a=$(t);if(a)for(const o of a)try{return await h(s,o,r)}catch(c){const{code:i}=c;if(i!=="ERR_MODULE_NOT_FOUND"&&i!=="ERR_PACKAGE_PATH_NOT_EXPORTED")throw c}}try{const a=await h(s,t,r);if(_(a.url)){const o=d(a.url);n&&!o&&(a.url+=`${a.url.includes("?")?"&":"?"}${f}${n}`)}return a}catch(a){if(a instanceof Error&&!e){const{code:o}=a;if(o==="ERR_UNSUPPORTED_DIR_IMPORT")try{return await U(t,r,s)}catch(c){if(c.code!=="ERR_PACKAGE_IMPORT_NOT_DEFINED")throw c}if(o==="ERR_MODULE_NOT_FOUND")try{return await l(t,r,s)}catch{}}throw a}};y(F)&&S&&A();export{G as globalPreload,W as initialize,z as load,j as resolve};
